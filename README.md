## Million-Queens

*计科1602 吴嘉梁 20167801*

### 一、暴力搜索和随机重复爬山

​	直观的暴力搜索优化到极致也只能处理几十皇后的问题，时间花费会随着皇后数量的变大成指数级增长，在如此大的数据量下是不可取的。但是我们可以知道，N皇后问题的可行解数量是很多的（尤其当$N$很大时），可以参见[OEIS-A000170](<https://oeis.org/A000170>)。所以我考虑使用随机重复爬山法，当N足够大时可以保证在一次搜索中就找到答案。

### 二、代价函数和结构

​	首先我们定义$d_i=permutaton(N)$，表示每一行的皇后位置，这样可以保证皇后之间的冲突只发生在对角线上。对于$permutation(N)$,可以在$O(N)$时间里生成均匀地随机排列。

```C++
for(int i=1; i<=N; i++)
    {
        swap(d[i],d[random(1,N)]);
    }
```

​	在$N*N$的棋盘上，共有$2*N-1$条正向对角线，$2*N-1$条负向对角线，一条正向对角线上$i-d_i$是相同的，一条负向对角线上$i+d_i$是相同的。所以我们可以以此统计任意一点在对角线上的冲突数，我们定义一条对角线上的冲突数等于对角线上的皇后数减一。当全局冲突数为$0$时，我们就找到了一个合适的解。

​	在这种定义下我们冲突数的最大值为$N-1$，每次循环遍历棋盘上的每一对点，尝试交换后是否会使冲突数减少，这样执行一次算法的时间复杂度就是$O(N^3)$。由于当$N$很大时，这个过程只会执行一次，所以算法的总体复杂度就是$O(N^3)$。

### 三、算法优化

​	上述算法跑$1e5$左右的数据就有点吃力了，如果在局部搜索中加入随机，能在$300s$左右的时间里跑出$1e6$的数据，比较接近要求但是还有一小段距离。

​	这个时候在我在Google Scholar上找到了一篇大神Rok Sosic 的论文，他在一篇1994年的论文中给出了一种在$55s$内求解$3e6$规模$N$皇后的算法，后面就是开始研究他的论文。

​	效用函数的定义我和他大致相同，但是他在生成序列和最后的搜索中有两项非常神奇的优化。首先是在初始化排列时，就尽量保证皇后之间没有冲突。通过随机，在棋盘左上角构造一个没有冲突的小正方形。可以证明在$3.08N$次随机尝试后就能构造一个很大的矩形，这样需要处理的皇后数就只在$100$以下。

下图引自论文。

![引自论文](C:\Users\Lethe\AppData\Roaming\Typora\typora-user-images\1558798868953.png)

​	其次就是对于有冲突的皇后的处理，对于每个有冲突的皇后$i$，我们取$j=random(1,N)$，如果交换$i,j$后两点都没有对角线上的冲突，则进行交换，可以证明每个皇后需要进行72次左右的随机尝试来找到可交换的位置。

​	以上两点优化的数学证明详见论文-----[Efficient local search with conflict minimization: A case study of the n-queens problem](https://ieeexplore.ieee.org/abstract/document/317698/)。

​	但是运行程序后会发现，对于$N$较小的情况$(N<200)$，这种方式并不是很好，所以对于这种情况，我们对有冲突的点遍历所有可能的交换情况，由于$N$很小，所以时间花费并不大。

​	我编写的程序运行结果如下。

| N     | 十次平均运行时间(s) |
| ----- | :-----------------: |
| $1e3$ |       0.00080       |
| $1e4$ |       0.00260       |
| $1e5$ |       0.02710       |
| $1e6$ |       0.48770       |
| $1e7$ |       7.98760       |
| $5e7$ |      48.59330       |



### 四、引用和讨论

主要参考了一下几篇论文。

 [1]. R. Sosic̆ J. Gu "A polynomial time algorithm for the n-queens problem" SIGART Bull. vol. 1 no. 3 pp. 7-11 Oct. 1990. 

[2] R. Sosic̆ J. Gu "3000000 queens in less than a minute" SIGART Bull. vol. 2 no. 2 pp. 22-24 Apr. 1991.   

[3]R. Sosič, J. Gu, " Efficient local search with conflict minimization: A casestudy of the $n$ -queen problem ", *IEEE Trans. Knowl. Data Eng.*, vol. 6, no. 5, pp. 661-668, 1994.

​	在写程序的过程中，我和1603班的金轶凡同学（20167846）进行了交流，分享了查到的论文并讨论了有关随机策略的问题，修正了一些随机函数上的错误。
